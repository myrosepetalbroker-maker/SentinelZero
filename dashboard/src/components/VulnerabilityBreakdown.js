import React from 'react';
import {
  Chart as ChartJS,
  ArcElement,
  Tooltip,
  Legend
} from 'chart.js';
import { Doughnut } from 'react-chartjs-2';
import './VulnerabilityBreakdown.css';

ChartJS.register(ArcElement, Tooltip, Legend);

function VulnerabilityBreakdown({ taxonomy, historicalData }) {
  if (!taxonomy || !historicalData) return null;

  // Count vulnerabilities from historical data
  const vulnerabilityCounts = {};
  
  historicalData.exploits.forEach(exploit => {
    const category = exploit.vulnerability_category;
    vulnerabilityCounts[category] = (vulnerabilityCounts[category] || 0) + 1;
  });

  const labels = Object.keys(vulnerabilityCounts);
  const counts = Object.values(vulnerabilityCounts);
  
  const colors = [
    '#FF0000', // Critical - red
    '#FF6B00', // High - orange
    '#FFD700', // Medium - yellow
    '#90EE90', // Low - green
    '#87CEEB', // Info - blue
    '#F3BA2F', // BNB yellow
    '#E5AB1F', // Gold
    '#4A90E2', // Blue
    '#00D97E', // Success green
    '#FF6B6B', // Danger red
  ];

  const data = {
    labels: labels,
    datasets: [
      {
        label: 'Incidents',
        data: counts,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: '#1E2329',
        borderWidth: 2,
      },
    ],
  };

  const options = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: {
          color: '#EAECEF',
          font: {
            family: 'Inter',
            size: 11
          },
          padding: 12,
          generateLabels: function(chart) {
            const data = chart.data;
            return data.labels.map((label, i) => ({
              text: `${label} (${data.datasets[0].data[i]})`,
              fillStyle: data.datasets[0].backgroundColor[i],
              hidden: false,
              index: i
            }));
          }
        }
      },
      tooltip: {
        backgroundColor: 'rgba(30, 35, 41, 0.95)',
        titleColor: '#EAECEF',
        bodyColor: '#B7BDC6',
        borderColor: '#2B3139',
        borderWidth: 1,
        padding: 12,
        callbacks: {
          label: function(context) {
            const label = context.label || '';
            const value = context.parsed;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = ((value / total) * 100).toFixed(1);
            return `${label}: ${value} incidents (${percentage}%)`;
          }
        }
      }
    }
  };

  return (
    <div className="card vulnerability-breakdown">
      <h2 className="card-title">ðŸŽ¯ Vulnerability Distribution</h2>
      <p className="card-description">
        Breakdown of exploits by vulnerability category
      </p>
      
      <div className="chart-container">
        <Doughnut data={data} options={options} />
      </div>

      <div className="vulnerability-list">
        <h3>Top Vulnerabilities</h3>
        {Object.entries(vulnerabilityCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .map(([category, count], index) => (
            <div key={category} className="vulnerability-item">
              <div className="vulnerability-rank">{index + 1}</div>
              <div className="vulnerability-info">
                <div className="vulnerability-name">{category}</div>
                <div className="vulnerability-count">{count} incidents</div>
              </div>
              <div className="vulnerability-percentage">
                {((count / historicalData.statistics.total_incidents) * 100).toFixed(1)}%
              </div>
            </div>
          ))}
      </div>
    </div>
  );
}

export default VulnerabilityBreakdown;
